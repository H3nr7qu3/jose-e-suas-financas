<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Transação - Finanças</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body class="min-h-screen flex bg-gray-100">

<!-- Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Edit Transaction Content -->
<main class="flex-1 p-8">
    <h2 class="text-2xl font-bold mb-6">Editar Transação</h2>

    <form class="space-y-4 max-w-md" th:action="@{/update}" method="post">
        <div th:if="${_csrf != null}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </div>
        <input type="hidden" name="id" th:value="${transaction.id}" />

        <div>
            <label class="block text-sm font-medium text-gray-700">Nome</label>
            <input type="text" name="name" th:value="${transaction.name}" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Valor</label>
            <input
                    type="text"
                    name="value-formatted"
                    id="value-formatted"
                    required
                    inputmode="decimal"
                    th:value="${#numbers.formatDecimal(transaction.value, 1, 2)}"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded"
            />
            <input type="hidden" name="value" id="original-value" />
        </div>

        <div>
            <ul class="items-center w-full text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg sm:flex">
                <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r">
                    <div class="flex items-center ps-3">
                        <input
                                id="radio-entry"
                                type="radio"
                                name="operation"
                                value="ENTRADA"
                                th:checked="${transaction.operation == T(com.ifmg.managementFinance.Entity.Operation).ENTRADA}"
                                required
                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500"
                        />
                        <label for="radio-entry" class="w-full py-3 ms-2 text-sm font-medium text-gray-900">Entrada</label>
                    </div>
                </li>
                <li class="w-full">
                    <div class="flex items-center ps-3">
                        <input
                                id="radio-expense"
                                type="radio"
                                name="operation"
                                value="SAIDA"
                                th:checked="${transaction.operation == T(com.ifmg.managementFinance.Entity.Operation).SAIDA}"
                                required
                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500"
                        />
                        <label for="radio-expense" class="w-full py-3 ms-2 text-sm font-medium text-gray-900">Saída</label>
                    </div>
                </li>
            </ul>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Data</label>
            <input type="date" name="entry_date" th:value="${#dates.format(transaction.entry_date, 'yyyy-MM-dd')}" class="mt-1 block w-full p-2 border border-gray-300 rounded" />
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Classificação</label>
            <select name="type" class="mt-1 block w-full p-2 border border-gray-300 rounded">
                <option th:each="type : ${types}" th:value="${type}" th:text="${type}" th:selected="${type == transaction.type}"></option>
            </select>
        </div>

        <button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Atualizar Transação</button>
    </form>

    <script>
        const currencyFormatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2
        });

        function updateOriginalValue(amount) {
            document.getElementById('original-value').value = amount.toFixed(2);
        }

        function formatCurrency(e) {
            const input = e.target;
            let numeric = input.value.replace(/\D/g, '');
            let amount = parseInt(numeric, 10) / 100;
            if (isNaN(amount)) amount = 0;
            const op = document.querySelector('input[name="operation"]:checked').value;
            // para saída, valor negativo
            amount = op === 'SAIDA' ? -Math.abs(amount) : Math.abs(amount);
            updateOriginalValue(amount);
            input.value = currencyFormatter.format(amount);
        }

        function applyFormatting() {
            const input = document.getElementById('value-formatted');
            let raw = input.getAttribute('value') || '0';
            raw = raw.replace(/\./g, '').replace(',', '.');
            let amount = parseFloat(raw);
            if (isNaN(amount)) amount = 0;
            const op = document.querySelector('input[name="operation"]:checked').value;
            amount = op === 'SAIDA' ? -Math.abs(amount) : Math.abs(amount);
            updateOriginalValue(amount);
            input.value = currencyFormatter.format(amount);
        }

        window.addEventListener('load', () => {
            applyFormatting();
            document.getElementById('value-formatted').addEventListener('input', formatCurrency);
            const radios = document.querySelectorAll('input[name="operation"]');
            radios.forEach(r => r.addEventListener('change', applyFormatting));
        });
    </script>

</main>
</body>
</html>
